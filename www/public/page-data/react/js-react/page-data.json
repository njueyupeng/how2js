{"componentChunkName":"component---src-templates-prose-tsx","path":"/react/js-react","result":{"data":{"post":{"slug":"/react/js-react","title":"记录一种将原生js项目改成react项目的方案","description":"记录一种将原生js项目改成react项目的方案","excerpt":"最近参与了一个老项目的改造，该项目使用原生js操作dom生成各种页面的，甚至连jquery都没有使用举例如下： 问题分析： 需要将原有通过原生操作dom的方式改成使用react进行开发 原有的类中包含大量业务逻辑，如果迁移业务逻辑到react…","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"记录一种将原生js项目改成react项目的方案\",\n  \"subtitle\": \"\",\n  \"date\": \"2021-07-19T00:00:00.000Z\",\n  \"lastUpdated\": \"2021-07-19T00:00:00.000Z\",\n  \"description\": \"记录一种将原生js项目改成react项目的方案\",\n  \"type\": \"prose\",\n  \"category\": \"React\",\n  \"image\": \"file-name-inside-og-images-folder.png\",\n  \"published\": true\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"\\u6700\\u8FD1\\u53C2\\u4E0E\\u4E86\\u4E00\\u4E2A\\u8001\\u9879\\u76EE\\u7684\\u6539\\u9020\\uFF0C\\u8BE5\\u9879\\u76EE\\u4F7F\\u7528\\u539F\\u751Fjs\\u64CD\\u4F5Cdom\\u751F\\u6210\\u5404\\u79CD\\u9875\\u9762\\u7684\\uFF0C\\u751A\\u81F3\\u8FDEjquery\\u90FD\\u6CA1\\u6709\\u4F7F\\u7528\\u4E3E\\u4F8B\\u5982\\u4E0B\\uFF1A\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"// detail.js\\n\\nclass Detail {\\n    constructor(parent){\\n        this.parent = parent;\\n        this.draw()\\n    }\\n    \\n    draw(){\\n        const detail = this.detail = document.createElement('div')\\n        detail.innerHtml = \\\"detail\\\"  \\n        parent.addendChild(detail)\\n    }\\n    \\n    // \\u5176\\u4ED6\\u4E1A\\u52A1\\u903B\\u8F91\\n    \\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"// parent\\n\\nclass Parent{\\n    constructor(){\\n        this.init();\\n    }\\n    init(){\\n        const Dom = document.createElement('div')\\n        this.Detail = new Detail(Dom)\\n        // ... \\u5176\\u4ED6\\u64CD\\u4F5C\\u903B\\u8F91\\n    }\\n}\\n\")), mdx(\"h2\", {\n    \"id\": \"问题分析：\"\n  }, \"\\u95EE\\u9898\\u5206\\u6790\\uFF1A\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"\\u9700\\u8981\\u5C06\\u539F\\u6709\\u901A\\u8FC7\\u539F\\u751F\\u64CD\\u4F5Cdom\\u7684\\u65B9\\u5F0F\\u6539\\u6210\\u4F7F\\u7528react\\u8FDB\\u884C\\u5F00\\u53D1\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"\\u539F\\u6709\\u7684\\u7C7B\\u4E2D\\u5305\\u542B\\u5927\\u91CF\\u4E1A\\u52A1\\u903B\\u8F91\\uFF0C\\u5982\\u679C\\u8FC1\\u79FB\\u4E1A\\u52A1\\u903B\\u8F91\\u5230react\\u7EC4\\u4EF6\\u4E2D\\uFF0C\\u4F1A\\u5E26\\u6765\\u5DE8\\u5927\\u7684\\u5DE5\\u4F5C\\u91CF\\u3002\")), mdx(\"h2\", {\n    \"id\": \"目标：\"\n  }, \"\\u76EE\\u6807\\uFF1A\"), mdx(\"p\", null, \"\\u590D\\u7528\\u539F\\u6709\\u7684\\u4E1A\\u52A1\\u903B\\u8F91\\uFF0C\\u53EA\\u62BD\\u79BBdom\\u6E32\\u67D3\\u7684\\u90E8\\u5206\\u3002\"), mdx(\"h2\", {\n    \"id\": \"最终实现：\"\n  }, \"\\u6700\\u7EC8\\u5B9E\\u73B0\\uFF1A\"), mdx(\"h3\", {\n    \"id\": \"1-改造原有的类，使之具有state状态\"\n  }, \"1. \\u6539\\u9020\\u539F\\u6709\\u7684\\u7C7B\\uFF0C\\u4F7F\\u4E4B\\u5177\\u6709state\\u72B6\\u6001\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"// StateFul\\nimport { Mixin } from \\\"./mixin\\\";\\nimport { waitLoopEnd } from \\\"./wait_loop\\\";\\n\\nexport const stateFulMixin = {\\n    constructor:function() {\\n        this.state = {}\\n        this._stateHooks = [];\\n        this._actionHooks = [];\\n        this._actionHooksMap = {};\\n        this._waitingUpdate = false;\\n        this._waitingDispatch = {};\\n    },\\n    setState: function(newState) {\\n        let state = { ...this.state };\\n        for(let key in newState) {\\n            state[key] = newState[key];\\n            if(!this._waitingDispatch[key]) {\\n                this._waitingDispatch[key] = true;\\n                waitLoopEnd(() => this._dispatchAction(key));\\n            }\\n        }\\n        this.state = state;\\n        if(!this._waitingUpdate) {\\n            this._waitingUpdate = true;\\n            waitLoopEnd(() => this._updateState());\\n        }\\n    },\\n    _dispatchAction: function(key) {\\n        this._waitingDispatch[key] = false;\\n        let action = { name:key, value: this.state[key] };\\n        let hookList = this._actionHooksMap[key];\\n        if(hookList) hookList.forEach(h => h(action));\\n        this._actionHooks.forEach(h => h(action));\\n    },\\n    _updateState:function() {\\n        this._waitingUpdate = false;\\n        this._stateHooks.forEach(h => h(this.state));\\n    },\\n    addHook: function(h) {\\n        let i = this._stateHooks.indexOf(h);\\n        if(i<0) this._stateHooks.push(h);\\n        return () => {\\n            let i = this._stateHooks.indexOf(h);\\n            if(i>=0) this._stateHooks.splice(i, 1);\\n        }\\n    },\\n\\n    addActionHook: function(h, acNames=[]) {\\n        if(acNames.length==0) {\\n            let i = this._actionHooks.indexOf(h);\\n            if(i<0) this._actionHooks.push(h);\\n            return () => {\\n                let i = this._actionHooks.indexOf(h);\\n                if(i>=0) this._actionHooks.splice(i, 1);\\n            }\\n        }\\n        else {\\n            for(let name of acNames) {\\n                let hookList = this._actionHooksMap[name];\\n                if(!hookList) {\\n                    hookList = this._actionHooksMap[name] = []\\n                }\\n                let i = hookList.indexOf(h);\\n                if(i<0) hookList.push(h);\\n            }\\n            return () => {\\n                for(let key in this._actionHooksMap) {\\n                    let list = this._actionHooksMap[key];\\n                    let i = list.indexOf(h);\\n                    if(i>=0) list.splice(i, 1);\\n                }\\n            }\\n        }\\n    }\\n}\\n\\nexport const StateFul = Mixin(class {}, stateFulMixin);\\n\\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"export function Mixin(targetClass, mixObject, prototypes=[]) {\\n\\n    const newClass = class extends targetClass{\\n        constructor(args1=[], args2=[]) {\\n            super(...args1);\\n            mixObject.constructor && mixObject.constructor.call(this, ...args2);\\n        }\\n    }\\n    const _prototype = newClass.prototype;\\n    if(prototypes.length) {\\n        for(let name of prototypes) {\\n            if(mixObject[name]) _prototype[name] = mixObject[name];\\n        }\\n    }\\n    else {\\n        for(let name in mixObject) {\\n            if(!_prototype.hasOwnProperty(name)) {\\n                _prototype[name] = mixObject[name];\\n            } \\n        }\\n    }\\n    return newClass;\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"export const waitLoopEnd = (() => {\\n    let loopEndPromise = null;\\n    let workBuffer = [];\\n    return (callback) => {\\n        if(loopEndPromise == null) {\\n            workBuffer = [];\\n            loopEndPromise = Promise.resolve();\\n            loopEndPromise.then(()=> {\\n                loopEndPromise = null;\\n                /**\\n                 * \\u9632\\u6B62\\u5728loopEnd \\u7684\\u65F6\\u5019\\u53C8\\u9047\\u5230 \\u6267\\u884C waitLoopEnd\\n                 * \\u6240\\u4EE5\\u4E0D\\u80FD\\u5728works\\u6267\\u884C\\u5B8C\\u6210\\u4E4B\\u540E\\u5C06workBuffer\\u6E05\\u7A7A, \\u5FC5\\u987B\\u5728\\u6267\\u884Cworks\\u4E4B\\u524D\\u5C31\\u628Abuffer\\u6E05\\u7A7A\\n                 * \\u5728\\u6267\\u884Cworks\\u8FC7\\u7A0B\\u4E2D\\u9047\\u5230\\u7684 waitLoopEnd, \\u7B49\\u5F85\\u4E0B\\u4E00\\u4E2A loopEndPromise\\n                 */\\n                 \\n                let works = [...workBuffer]\\n                workBuffer = [];\\n                works.forEach(cb =>{\\n                    try{\\n                        cb();\\n                    }\\n                    catch(e) {\\n                        console.log(\\\"test: loop ended cb error\\\")\\n                    }\\n                });\\n            })\\n        }\\n        workBuffer.push(callback);\\n    }\\n})();\\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"class Detail Extends StateFul {\\n    constructor(parent){\\n        super()\\n        this.state = {detail:''}\\n        this.parent = parent;\\n        this.draw()\\n    }\\n    \\n    draw(){\\n        const detail = this.detail = document.createElement('div')\\n        detail.innerHtml = \\\"detail\\\"  \\n        parent.addendChild(detail)\\n    }\\n    \\n    // \\u5176\\u4ED6\\u4E1A\\u52A1\\u903B\\u8F91\\n    \\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"2-构造页面组件，来监听原有类的state渲染页面\"\n  }, \"2. \\u6784\\u9020\\u9875\\u9762\\u7EC4\\u4EF6\\uFF0C\\u6765\\u76D1\\u542C\\u539F\\u6709\\u7C7B\\u7684state,\\u6E32\\u67D3\\u9875\\u9762\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"import React, { useState, useEffect } from 'react'\\n\\nexport function useConState(container, stateKey) {\\n\\n    const [state, setState] = useState(stateKey == undefined ? container.state : container.state[stateKey]);\\n\\n    useEffect(() => {\\n        if (stateKey !== undefined) {\\n            return container.addActionHook(({ value }) => setState(value), [stateKey]);\\n        }\\n        setState(container.state)\\n        return container.addHook(setState)\\n    }, [])\\n\\n\\n    return state\\n}\\n\\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \" export default function DetailDIV (){\\n     const {detail} = useConState(detailInstanceF)\\n     return <div>{detail}</div>\\n }\\n\")));\n}\n;\nMDXContent.isMDXComponent = true;","seoLastUpdated":"2021-07-19T00:00:00.000Z","lastUpdated":"Jul 19, 2021","seoDate":"2021-07-19T00:00:00.000Z","yearDate":"2021","date":"Jul 19, 2021","subtitle":null,"timeToRead":1,"image":"file-name-inside-og-images-folder.png","category":{"name":"React","slug":"/react"},"parent":{"parent":{"relativePath":"2021-07-19--js-react/index.mdx"}}}},"pageContext":{"slug":"/react/js-react"}},"staticQueryHashes":["3050858678","4184542181","492144057","712324210"]}